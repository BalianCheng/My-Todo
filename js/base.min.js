/**
 * Created by Dovahkiin on 2017/3/29.
 */(function(){function v(a){return store.get("task_list")[a]}function D(a){a||console.error("title is required!");var b={},c,d,n,f,e;n=$.Deferred();"string"==typeof a?b.title=a:b=$.extend(b,a);c=$('\x3cdiv\x3e\x3cdiv class\x3d"box_title"\x3e\u63d0\u793a\x3c/div\x3e\x3cdiv class\x3d"box_content"\x3e'+b.title+'\x3c/div\x3e\x3cdiv class\x3d"btn"\x3e\x3cbutton class\x3d"primary" type\x3d"button"\x3e\u786e\u5b9a\x3c/button\x3e\x3cbutton class\x3d"cancel" type\x3d"button"\x3e\u53d6\u6d88\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e').css({height:150,width:300,background:"#ffffff",color:"#444","border-radius":3,"box-shadow":"0 1px 2px rgba(0,0,0,0.5)",position:"relative",margin:"0 auto"});c.find(".btn").css({bottom:"5"});c.find(".box_title").css({padding:"5px 10px","font-weight":900,"font-size":20,background:"#4eaff5","border-radius":"3 0 0 3","text-align":"center"});c.find(".box_content").css({padding:"5px 10px","text-align":"center","vertical-align":"middle",top:20,position:"relative"});d=$("\x3cdiv\x3e\x3c/div\x3e").css({position:"fixed",top:0,right:0,bottom:0,left:0,background:"rgba(30, 30, 30, 0.4)"});b=c.find(".btn");a=b.find("button.primary");b=b.find("button.cancel");e=setInterval(function(){void 0!==f&&(n.resolve(f),clearInterval(e),d.remove(),c.remove())},50);a.on("click",function(){f=!0});b.on("click",function(){f=!1});d.on("click",function(){f=!1});g.on("resize",function(){var a=g.width(),b=g.height(),d=c.width();c.css({left:(a-d)/2,top:(b-c.height)/2-20})});d.appendTo(w);c.appendTo(w);g.resize();return n.promise()}function E(){x.on("click",function(){var a=$(this).parent().parent().data("index");F(a);p.show();e.show()})}function h(a,b){!d[a]||0>a||(d[a]=$.extend({},d[a],b),y())}function q(){p.hide();e.hide()}function F(a){if(void 0!==a&&d[a]){var b=d[a],b='\x3cform\x3e\x3cdiv class\x3d"content"\x3e'+b.content+'\x3c/div\x3e\x3cdiv class\x3d"input_item"\x3e\x3cinput style\x3d"display: none" type\x3d"text" name\x3d"content" value\x3d"'+(b.content||"")+'"\x3e\x3c/div\x3e\x3cdiv\x3e\x3cdiv class\x3d"desc input_item"\x3e\x3ctextarea autofocus name\x3d"desc"\x3e'+(b.desc||"")+'\x3c/textarea\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"remind clearFix input_item"\x3e\x3clabel for\x3d"remind_date"\x3e\u63d0\u9192\u65f6\u95f4\x3c/label\x3e\x3cinput type\x3d"text" id\x3d"remind_date" name\x3d"remind_date" value\x3d"'+(b.remind_date||"")+'"\x3e\x3cbutton type\x3d"submit"\x3e\u66f4\u65b0\x3c/button\x3e\x3c/div\x3e\x3c/form\x3e';e.html(null);e.html(b);$("#remind_date").datetimepicker();k=e.find("form");r=k.find(".content");z=k.find("[name\x3dcontent]");r.on("dblclick",function(){r.hide();z.show()});k.on("submit",function(b){b.preventDefault();b={};b.content=$(this).find("[name\x3dcontent]").val();b.desc=$(this).find("textarea[name\x3ddesc]").val();b.remind_date=$(this).find("[name\x3dremind_date]").val();h(a,b);q()})}}function G(){A.on("click",function(){var a=$(this).parent().parent().data("index");D("\u786e\u5b9a\u5220\u9664\uff1f").then(function(b){b?void 0!==a&&d[a]&&(delete d[a],y()):null})})}function H(){B.on("click",function(){var a=$(this);$(this).is(":checked");a=a.parent().parent().data("index");v(a).complete?h(a,{complete:!1}):h(a,{complete:!0})})}function y(){store.set("task_list",d);t()}function t(){var a=$(".task-list");a.html("");for(var b=[],c=0,m=d.length;c<m;c++){var e=d[c];if(e&&e.complete)b[c]=e;else var f=C(d[c],c);a.prepend(f)}c=0;for(m=b.length;c<m;c++)if(f=C(b[c],c))f.addClass("completed"),a.append(f);A=$(".anchor.delete");x=$(".anchor.detail");B=$(".task-list .complete[type\x3dcheckbox]");G();E();H()}function C(a,b){if(a&&0<=b)return $('\x3cdiv class\x3d"task-item" data-index\x3d"'+b+'"\x3e\x3cspan\x3e\x3cinput class\x3d"complete" '+(a.complete?"checked":"")+' type\x3d"checkbox"\x3e\x3c/span\x3e\x3cspan class\x3d"task-content"\x3e'+a.content+'\x3c/span\x3e\x3cspan class\x3d"floatRight"\x3e\x3cspan class\x3d"anchor delete"\x3e \u5220\u9664\x3c/span\x3e\x3cspan class\x3d"anchor detail"\x3e \u8be6\u7ec6\x3c/span\x3e\x3c/span\x3e\x3c/div\x3e')}var I=$(".add-task"),g=$("window"),d={},A,w=$("body"),x,e=$(".task-detail"),p=$(".task-detail-mask"),k,r,z,B,l=$(".msg"),J=l.find(".msg-Content"),K=l.find("button"),u=$(".alerter")[0],d=store.get("task_list")||[];d.length&&t();(function(){var a;setInterval(function(){for(var b=0,c=d.length;b<c;b++){var e=v(b);e&&e.remind_date&&!e.informed&&(a=(new Date).getTime(),1<=(new Date(e.remind_date)).getTime()-a&&(h(b,{informed:!0}),e=e.content))&&(J.html(e),u.play(),l.show())}},500)})();(function(){K.on("click",function(){l.hide();u.pause();u.currentTime=0})})();I.on("submit",function(a){a.preventDefault();a={};var b=$(this).find("input[name\x3dcontent]");b.val()&&(a.content=b.val(),a&&(d.push(a),store.set("task_list",d),t(),b.val(null)))});p.on("click",q);$("h1").on("click",q)})();